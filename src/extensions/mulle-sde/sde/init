#! /usr/bin/env bash

[ "${TRACE}" = "YES" ] && set -x && : "$0" "$@"


setup_gitignore()
{
   fgrep -q -s 'generated by mulle-sde' .gitignore
   case $? in
      0)
         return 0
      ;;
   esac


   text='.gitignore

# ### > generated by mulle-sde (extensions/mulle-sde/sde/init)

# generally /var and directories are not interesting
.mulle-*/var/

# .mulle-env /bin and /libexec are not interesting

.mulle-env/bin/
.mulle-env/libexec/

# style is "fluctuating" on a per-user level so not interesting
.mulle-env/etc/style

# .mulle-sde is generally interesting

# .mulle-sourcetree is generally boring, except /etc
.mulle-sourcetree/
!.mulle-sourcetree/etc

# dynamically .mulle-sourcetree-fix is boring
.mulle-sourcetree-fix

# stashes are generally boring
stashes/

# ### < generated by mulle-sde (extensions/sde/init)
'

   redirect_append_exekutor .gitignore echo "${text}"
}


install_bash_completion()
{
   local filename

   local text

   text='\
#! /usr/bin/env bash

#
# install completion if not yet present.
# mulle-sde-bash-completion.sh will load the inferior completes
#
if [ "`type -t "_mulle_sde_complete"`" != "function" ]
then
   . "$(mulle-sde libexec-dir)/mulle-sde-bash-completion.sh"
fi
'

   local dstdir

   chmod -R ug+wX ".mulle-env/share"

   dstdir=".mulle-env/share/libexec"

   mkdir_if_missing "${dstdir}"
   redirect_exekutor "${dstdir}/load-bash-completion.sh" echo "${text}"
   # we supercede this
   remove_file_if_present "${dstdir}/mulle-env-bash-completion.sh"
   chmod -R a-w ".mulle-env/share"
}


main()
{
   setup_gitignore
   install_bash_completion
}

########
###
### INIT
###
_init()
{
   if [ -z "${MULLE_BASHFUNCTIONS_LIBEXEC_DIR}" ]
   then
      MULLE_BASHFUNCTIONS_LIBEXEC_DIR="`mulle-bashfunctions-env libexec-dir 2> /dev/null`"
      if [ -z "${MULLE_BASHFUNCTIONS_LIBEXEC_DIR}" ]
      then
         if [ -z "`command -v "mulle-bashfunctions-env"`" ]
         then
            echo "Fatal Error: Could not find mulle-bashfunctions-env in PATH (not installed ?)" >&2
         else
            echo "Fatal Error: Could not find libexec of mulle-bashfunctions-env ($PWD)" >&2
         fi
         exit 1
      fi
   fi

   # shellcheck source=../mulle-bashfunctions/src/mulle-string.sh
   . "${MULLE_BASHFUNCTIONS_LIBEXEC_DIR}/mulle-bashfunctions.sh"  || \
      (
         echo "failed to load bashfunctions from ${MULLE_BASHFUNCTIONS_LIBEXEC_DIR}" >&2  &&
         exit 1
      )
}
###
### INIT
###
########


_init "$@" # needs params
main "$@"
